{% extends "booking_app/base.html" %}
{% block title %}Calendar{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-lg-10">
    <div class="card-soft p-3 p-md-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <h1 class="mb-1">Nazar’s Calendar</h1>
          <span class="time-badge kicker">Chicago time</span>
        </div>
      </div>

      <div id="calendar"></div>

      <div class="stats-row mt-3" aria-label="Dashboard counts">
        <div class="stats-pill">
          <span class="stats-label">Today</span>
          <span class="stats-value" id="todayBookingCount">0</span>
          <span class="stats-suffix">bookings</span>
        </div>
        <div class="stats-pill">
          <span class="stats-label">Pending</span>
          <span class="stats-value" id="pendingAppCount">0</span>
          <span class="stats-suffix">applications</span>
        </div>
      </div>

      <div class="mt-3 d-flex justify-content-start">
        <a
          class="btn btn-accent"
          id="createBookingBtn"
          href="/book/?admin=1&next=/calendar/"
        >
          Create booking
        </a>
      </div>

      <div id="detailCard" class="detail-card d-none mt-3" aria-live="polite">
        <div class="detail-header">
          <div>
            <div class="detail-title" id="detailTitle">Booking</div>
            <div class="detail-sub" id="detailWhen"></div>
          </div>
          <button
            type="button"
            class="btn btn-sm btn-outline-secondary text-nowrap"
            id="detailClose"
            aria-label="Close details"
          >
            Close
          </button>
        </div>

        <div class="detail-body">
          <div class="detail-line">
            <span class="detail-label">Status</span>
            <span class="badge-soft" id="detailStatusPill">
              <span class="dot" aria-hidden="true"></span>
              <span id="detailStatus"></span>
            </span>
          </div>

          <div class="detail-line mt-2">
            <span class="detail-label">Address</span>
            <span
              class="detail-address"
              id="detailAddress"
            ></span>
          </div>

          <div class="detail-line mt-2">
            <span class="detail-label">Start</span>
            <span class="detail-sub" id="detailStartText"></span>
          </div>

          <div class="detail-line mt-2">
            <span class="detail-label">End</span>
            <span class="detail-sub" id="detailEndText"></span>
          </div>

          <div class="detail-line mt-2 d-none" id="detailEditRow">
            <div class="d-flex gap-2 flex-wrap align-items-center">
              <input
                type="datetime-local"
                class="form-control form-control-sm"
                id="detailStart"
                style="max-width: 240px"
              />
              <span class="small text-muted">to</span>
              <input
                type="datetime-local"
                class="form-control form-control-sm"
                id="detailEnd"
                style="max-width: 240px"
              />
            </div>
          </div>
        </div>

        <div class="detail-actions d-flex gap-2 align-items-center flex-row flex-wrap">
          <button
            type="button"
            class="btn btn-outline-secondary text-nowrap"
            id="detailCopy"
          >
            Copy address
          </button>

          <button
            type="button"
            class="btn btn-outline-secondary text-nowrap"
            id="detailEditTime"
          >
            Edit time
          </button>

          <button
            type="button"
            class="btn btn-outline-secondary text-nowrap d-none"
            id="detailCancelEdit"
          >
            Cancel edit
          </button>

          <button
            type="button"
            class="btn btn-outline-secondary text-nowrap"
            id="detailConfirm"
          >
            Confirm
          </button>

          <button
            type="button"
            class="btn btn-outline-secondary text-nowrap"
            id="detailDecline"
          >
            Decline
          </button>

          <button
            type="button"
            class="btn btn-outline-danger text-nowrap"
            id="detailCancel"
          >
            Cancel
          </button>

          <button
            type="button"
            class="btn btn-outline-secondary text-nowrap d-none"
            id="detailSaveTime"
          >
            Save time
          </button>

          <a class="btn btn-accent text-nowrap" href="/bookings_list/" id="detailOpenBookings">
            Open bookings
          </a>
        </div>
      </div>




      <div class="mt-3 section-card">
        <button
          type="button"
          class="section-toggle"
          id="toggleApps"
          aria-expanded="true"
        >
          <span class="section-title">New client applications</span>
          <span class="small text-muted" id="appCount"></span>
          <span class="section-caret" aria-hidden="true">▾</span>
        </button>

        <div id="appSection">
          <div class="list-group" id="appList"></div>
          <div class="small text-muted mt-2">
            Pending only. Approve or decline here. Admin is optional.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<link
  href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css"
  rel="stylesheet"
/>
<script
  src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js">
</script>

<script>
  document.addEventListener("DOMContentLoaded", async function () {
    const el = document.getElementById("calendar");
    const appListEl = document.getElementById("appList");
    const appCountEl = document.getElementById("appCount");
    const todayCountEl = document.getElementById("todayBookingCount");
    const pendingCountEl = document.getElementById("pendingAppCount");

    const createBtn = document.getElementById("createBookingBtn");

    const detailCard = document.getElementById("detailCard");
    const detailTitle = document.getElementById("detailTitle");
    const detailWhen = document.getElementById("detailWhen");
    const detailAddress = document.getElementById("detailAddress");
    const detailStatus = document.getElementById("detailStatus");
    const detailCopy = document.getElementById("detailCopy");
    const detailConfirm = document.getElementById("detailConfirm");
    const detailDecline = document.getElementById("detailDecline");
    const detailCancel = document.getElementById("detailCancel");
    const detailClose = document.getElementById("detailClose");
    const detailStart = document.getElementById("detailStart");
    const detailEnd = document.getElementById("detailEnd");
    const detailSaveTime = document.getElementById("detailSaveTime");

    const detailStartText = document.getElementById("detailStartText");
    const detailEndText = document.getElementById("detailEndText");
    const detailEditRow = document.getElementById("detailEditRow");
    const detailEditTime = document.getElementById("detailEditTime");
    const detailCancelEdit = document.getElementById("detailCancelEdit");

    let isEditingTime = false;

    let activeBookingId = "";
    let activeBookingStatus = "";

    function showToast(message) {
      let wrap = document.getElementById("toastWrap");
      if (!wrap) {
        wrap = document.createElement("div");
        wrap.id = "toastWrap";
        wrap.className = "toast-wrap";
        document.body.appendChild(wrap);
      }

      const t = document.createElement("div");
      t.className = "toast";
      t.textContent = message;
      wrap.appendChild(t);

      window.setTimeout(() => {
        t.remove();
      }, 2200);
    }

    let selectedStart = null;
    let selectedEnd = null;
    let selectedStartStr = "";
    let selectedEndStr = "";

    function fmtChicago(iso) {
      try {
        const d = new Date(iso);
        const fmt = new Intl.DateTimeFormat("en-US", {
          timeZone: "America/Chicago",
          weekday: "short",
          month: "short",
          day: "numeric",
          hour: "numeric",
          minute: "2-digit",
        });
        return fmt.format(d);
      } catch (e) {
        return "";
      }
    }

    function timeOnly(iso) {
      try {
        const d = new Date(iso);
        const fmt = new Intl.DateTimeFormat("en-US", {
          timeZone: "America/Chicago",
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        });
        return fmt.format(d);
      } catch (e) {
        return "";
      }
    }

    function chicagoDayKey(isoOrDate) {
      const d = typeof isoOrDate === "string"
        ? new Date(isoOrDate)
        : isoOrDate;

      const parts = new Intl.DateTimeFormat("en-US", {
        timeZone: "America/Chicago",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
      }).formatToParts(d);

      const y = parts.find((p) => p.type === "year")?.value || "";
      const m = parts.find((p) => p.type === "month")?.value || "";
      const da = parts.find((p) => p.type === "day")?.value || "";

      return `${y}-${m}-${da}`;
    }

    function jumpTo(calendar, iso) {
      if (!iso) return;

      calendar.changeView("timeGridDay");
      calendar.gotoDate(iso);

      const t = timeOnly(iso);
      if (t && typeof calendar.scrollToTime === "function") {
        const hhmm = new Date(iso).toISOString().slice(11, 16);
        calendar.scrollToTime(hhmm);
      }
    }

    function setExpanded(btn, section, expanded) {
      if (!btn || !section) return;

      btn.setAttribute("aria-expanded", expanded ? "true" : "false");
      btn.classList.toggle("is-collapsed", !expanded);

      if (expanded) {
        section.classList.remove("d-none");
      } else {
        section.classList.add("d-none");
      }
    }

    async function tryCopy(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch (e) {
          return fallbackCopy(text);
        }
      }
      return fallbackCopy(text);
    }

    function fallbackCopy(text) {
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.setAttribute("readonly", "");
      ta.style.position = "fixed";
      ta.style.top = "0";
      ta.style.left = "0";
      ta.style.width = "1px";
      ta.style.height = "1px";
      ta.style.opacity = "0";
      ta.style.pointerEvents = "none";

      document.body.appendChild(ta);

      ta.focus({ preventScroll: true });
      ta.select();
      ta.setSelectionRange(0, ta.value.length);

      let ok = false;
      try {
        ok = document.execCommand("copy");
      } catch (e) {
        ok = false;
      }

      ta.remove();
      return ok;
    }

    function getCookie(name) {
      const v = document.cookie || "";
      const parts = v.split(";");
      for (let i = 0; i < parts.length; i++) {
        const p = parts[i].trim();
        if (p.startsWith(name + "=")) {
          return decodeURIComponent(p.substring(name.length + 1));
        }
      }
      return "";
    }

    async function postAppAction(appId, action) {
      const csrf = getCookie("csrftoken");
      const url = `/api/application/${appId}/action/`;

      const body = new URLSearchParams();
      body.set("action", action);

      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Accept": "application/json",
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          "X-CSRFToken": csrf,
        },
        body: body.toString(),
      });

      if (!res.ok) {
        return { ok: false };
      }

      try {
        return await res.json();
      } catch (e) {
        return { ok: false };
      }
    }

    async function postBookingAction(bookingId, action) {
      const csrf = getCookie("csrftoken");
      const url = `/api/booking/${bookingId}/action/`;

      const body = new URLSearchParams();
      body.set("action", action);

      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Accept": "application/json",
          "Content-Type":
            "application/x-www-form-urlencoded;charset=UTF-8",
          "X-CSRFToken": csrf,
        },
        body: body.toString(),
      });

      if (!res.ok) {
        return { ok: false };
      }

      try {
        return await res.json();
      } catch (e) {
        return { ok: false };
      }
    }

    async function postBookingCancel(bookingId) {
      const csrf = getCookie("csrftoken");
      const url = `/api/booking/${bookingId}/cancel/`;

      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Accept": "application/json",
          "X-CSRFToken": csrf,
        },
      });

      if (!res.ok) {
        return { ok: false };
      }

      try {
        return await res.json();
      } catch (e) {
        // Some endpoints may return empty body
        return { ok: true };
      }
    }

    function toChicagoLocal(d) {
      try {
        const parts = new Intl.DateTimeFormat("en-US", {
          timeZone: "America/Chicago",
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        }).formatToParts(d);

        const y = parts.find((p) => p.type === "year")?.value || "";
        const m = parts.find((p) => p.type === "month")?.value || "";
        const da = parts.find((p) => p.type === "day")?.value || "";
        const hh = parts.find((p) => p.type === "hour")?.value || "";
        const mm = parts.find((p) => p.type === "minute")?.value || "";

        if (!y || !m || !da || !hh || !mm) return "";

        return `${y}-${m}-${da}T${hh}:${mm}:00`;
      } catch (e) {
        return "";
      }
    }

    function toChicagoLocalInputValue(iso) {
      try {
        if (!iso) return "";
        const d = new Date(iso);
        const local = toChicagoLocal(d);
        if (!local) return "";
        // datetime-local expects YYYY-MM-DDTHH:MM
        return local.slice(0, 16);
      } catch (e) {
        return "";
      }
    }

    function addHours(d, hours) {
      const x = new Date(d.getTime());
      x.setHours(x.getHours() + hours);
      return x;
    }

    function updateCreateLink() {
      if (!createBtn) return;

      if (!selectedStartStr || !selectedEndStr) {
        createBtn.href = "/book/?admin=1&next=/calendar/";
        return;
      }

      const s = encodeURIComponent(selectedStartStr);
      const e = encodeURIComponent(selectedEndStr);
      createBtn.href = `/book/?admin=1&next=/calendar/&slot_start=${s}&slot_end=${e}`;
    }

    function showDetails(title, startIso, endIso, address, status) {
      if (!detailCard) return;

      if (detailTitle) {
        detailTitle.textContent = title || "Booking";
      }

      if (detailWhen) {
        if (startIso) {
          const startTxt = fmtChicago(startIso);
          const endTxt = endIso ? timeOnly(endIso) : "";
          detailWhen.textContent = endTxt ? `${startTxt} – ${endTxt}` : startTxt;
        } else {
          detailWhen.textContent = "";
        }
      }

      if (detailStartText) {
        detailStartText.textContent = startIso ? fmtChicago(startIso) : "";
      }

      if (detailEndText) {
        detailEndText.textContent = endIso ? timeOnly(endIso) : "";
      }

      const st = (status || "").trim() || "new";
      activeBookingStatus = st;

      if (detailStatus) {
        detailStatus.textContent = st;
      }

      const isActionable = st === "new" || st === "pending";
      const isConfirmed = st === "confirmed";

      if (detailConfirm) {
        detailConfirm.disabled = !isActionable;
        detailConfirm.classList.toggle("d-none", !isActionable);
      }

      if (detailDecline) {
        detailDecline.disabled = !isActionable;
        detailDecline.classList.toggle("d-none", !isActionable);
      }

      if (detailCancel) {
        detailCancel.classList.toggle("d-none", !isConfirmed);
      }

      if (detailAddress) {
        detailAddress.textContent = address || "No address";
      }

      const isCancelled = st === "cancelled";
      const isDeclined = st === "declined";
      const canEditTime = !!activeBookingId && !isCancelled && !isDeclined;

      // Reset edit mode whenever a new booking is opened
      isEditingTime = false;
      if (detailEditRow) detailEditRow.classList.add("d-none");

      if (detailEditTime) {
        detailEditTime.disabled = !canEditTime;
        detailEditTime.classList.toggle("d-none", !canEditTime);
      }

      if (detailCancelEdit) {
        detailCancelEdit.classList.add("d-none");
      }

      if (detailSaveTime) {
        detailSaveTime.classList.add("d-none");
        detailSaveTime.disabled = false;
      }

      if (detailStart) {
        detailStart.disabled = !canEditTime;
        detailStart.value = toChicagoLocalInputValue(startIso);
      }

      if (detailEnd) {
        detailEnd.disabled = !canEditTime;
        detailEnd.value = toChicagoLocalInputValue(endIso);
      }

      detailCard.classList.remove("d-none");
      detailCard.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }

    function hideDetails() {
      if (!detailCard) return;
      isEditingTime = false;
      if (detailEditRow) detailEditRow.classList.add("d-none");
      if (detailEditTime) {
        detailEditTime.disabled = false;
        detailEditTime.classList.remove("d-none");
      }
      if (detailCancelEdit) detailCancelEdit.classList.add("d-none");
      if (detailSaveTime) {
        detailSaveTime.disabled = false;
        detailSaveTime.classList.add("d-none");
      }
      if (detailStart) detailStart.value = "";
      if (detailEnd) detailEnd.value = "";
      if (detailStartText) detailStartText.textContent = "";
      if (detailEndText) detailEndText.textContent = "";
      detailCard.classList.add("d-none");
      activeBookingId = "";
      activeBookingStatus = "";

      if (detailConfirm) {
        detailConfirm.disabled = false;
        detailConfirm.classList.remove("d-none");
      }

      if (detailDecline) {
        detailDecline.disabled = false;
        detailDecline.classList.remove("d-none");
      }

      if (detailCancel) {
        detailCancel.classList.add("d-none");
      }
    }
    async function postBookingReschedule(bookingId, startLocal, endLocal) {
      const csrf = getCookie("csrftoken");
      const url = `/api/booking/${bookingId}/reschedule/`;

      const body = new URLSearchParams();
      body.set("scheduled_start", startLocal);
      body.set("scheduled_end", endLocal);

      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Accept": "application/json",
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          "X-CSRFToken": csrf,
        },
        body: body.toString(),
      });

      if (!res.ok) {
        return { ok: false };
      }

      try {
        return await res.json();
      } catch (e) {
        return { ok: false };
      }
    }

    let data = [];
    try {
      const res = await fetch("/api/calendar-events/");
      if (res.ok) {
        data = await res.json();
      }
    } catch (e) {
      data = [];
    }

    data.sort((a, b) => {
      const as = a.start || "";
      const bs = b.start || "";
      return as.localeCompare(bs);
    });


    const calendar = new FullCalendar.Calendar(el, {
      timeZone: "America/Chicago",
      initialView: "dayGridMonth",
      height: "auto",
      slotMinTime: "08:00:00",
      slotMaxTime: "21:00:00",
      scrollTime: "08:00:00",
      slotDuration: "00:30:00",
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay",
      },
      events: data,
      eventClassNames: function (arg) {
        const props = arg.event.extendedProps || {};
        const status = props.status ? String(props.status).toLowerCase() : "";
        if (status === "pending" || status === "new") {
          return ["event-pending"];
        }
        return ["event-slot"]; // confirmed + everything else uses the blue slot tile
      },
      dateClick: function (info) {
        calendar.changeView("timeGridDay");
        calendar.gotoDate(info.dateStr);

        // Use the clicked day string (Chicago calendar day) to avoid day-shift bugs
        selectedStartStr = `${info.dateStr}T09:00:00`;
        selectedEndStr = `${info.dateStr}T10:00:00`;

        // Keep Date objects updated too (used elsewhere)
        selectedStart = info.date;
        selectedEnd = addHours(info.date, 1);

        updateCreateLink();
      },
      eventClick: function (info) {
        info.jsEvent.preventDefault();

        const title = info.event.title || "Booking";
        const startIso = info.event.startStr || "";
        const endIso = info.event.endStr || "";
        const props = info.event.extendedProps || {};
        const addr = props.address ? props.address : "";

        const bookingId = props.booking_id
          ? String(props.booking_id)
          : String(info.event.id || "");

        const status = props.status
          ? String(props.status)
          : "pending";

        activeBookingId = bookingId;

        showDetails(title, startIso, endIso, addr, status);
      },
    });

    calendar.render();

    // Default create-booking link to "today" in Chicago
    const todayKey = chicagoDayKey(new Date());
    selectedStartStr = `${todayKey}T09:00:00`;
    selectedEndStr = `${todayKey}T10:00:00`;

    selectedStart = new Date();
    selectedEnd = addHours(selectedStart, 1);
    updateCreateLink();

    if (todayCountEl) {
      const todayKey = chicagoDayKey(new Date());
      const todayBookings = data.filter((e) => {
        if (!e.start) return false;
        return chicagoDayKey(e.start) === todayKey;
      }).length;
      todayCountEl.textContent = String(todayBookings);
    }

    let apps = [];
    try {
      const resApps = await fetch("/api/pending-applications/");
      if (resApps.ok) {
        apps = await resApps.json();
      }
    } catch (e) {
      apps = [];
    }

    if (appCountEl) {
      appCountEl.textContent = apps.length ? `${apps.length} pending` : "";
    }

    if (pendingCountEl) {
      pendingCountEl.textContent = String(apps.length);
    }

    if (appListEl) {
      appListEl.innerHTML = "";

      function updatePendingCounters(newCount) {
        if (appCountEl) {
          appCountEl.textContent = newCount ? `${newCount} pending` : "";
        }
        if (pendingCountEl) {
          pendingCountEl.textContent = String(newCount);
        }
      }

      function renderEmptyApps() {
        appListEl.innerHTML = "";
        const emptyA = document.createElement("div");
        emptyA.className = "text-muted small";
        emptyA.textContent = "No pending applications.";
        appListEl.appendChild(emptyA);
      }

      apps.slice(0, 30).forEach((a) => {
        const item = document.createElement("div");
        item.className = "card-soft p-3 mb-2 app-tile";
        item.dataset.appId = String(a.id || "");

        const name = a.name || "Application";
        const zip = a.zip_code ? `ZIP ${a.zip_code}` : "";
        const addr = a.address || "";
        const when = a.created ? fmtChicago(a.created) : "";
        const meta = [addr, zip, when].filter(Boolean).join(" · ");

        const adminUrl = a.admin_url || "";
        const adminHtml = adminUrl
          ? `<a class="app-admin-link" href="${adminUrl}" target="_blank" rel="noopener">Admin</a>`
          : "";

        item.innerHTML =
          `<div class="app-row">`
          +
          `<div>`
          +
          `<div class="fw-semibold">${name}</div>`
          +
          `<div class="small text-muted app-meta">${meta}</div>`
          +
          `${adminHtml ? `<div class="mt-1">${adminHtml}</div>` : ""}`
          +
          `</div>`
          +
          `<div class="app-actions d-flex gap-2 justify-content-end align-items-center flex-row flex-wrap">`
          +
          `<button type="button" class="btn btn-sm btn-outline-secondary btn-copy text-nowrap" data-action="copy">Copy address</button>`
          +
          `<button type="button" class="btn btn-sm btn-outline-secondary btn-approve text-nowrap" data-action="approve">Approve</button>`
          +
          `<button type="button" class="btn btn-sm btn-outline-secondary btn-decline text-nowrap" data-action="decline">Decline</button>`
          +
          `</div>`
          +
          `</div>`;

        item.addEventListener("click", (ev) => {
          const btn = ev.target.closest("button[data-action]");
          if (!btn) return;
          ev.preventDefault();
          ev.stopPropagation();

          const appId = item.dataset.appId;
          const action = (btn.getAttribute("data-action") || "").trim();
          if (!appId || !action) return;

          if (action === "copy") {
            const text = (a.address || "").trim();
            if (!text) {
              showToast("No address to copy");
              return;
            }

            (async () => {
              const ok = await tryCopy(text);
              if (!ok) {
                window.prompt("Copy address (Cmd+C):", text);
                return;
              }
              showToast("Address copied");
            })();
            return;
          }

          const approveBtn = item.querySelector(
            'button[data-action="approve"]'
          );
          const declineBtn = item.querySelector(
            'button[data-action="decline"]'
          );

          if (approveBtn) approveBtn.disabled = true;
          if (declineBtn) declineBtn.disabled = true;

          (async () => {
            // Optimistic UI: remove immediately
            apps = apps.filter((x) => String(x.id) !== String(appId));
            item.remove();
            updatePendingCounters(apps.length);
            if (!apps.length) renderEmptyApps();

            const resp = await postAppAction(appId, action);

            if (!resp || resp.error) {
              showToast("Server error, refresh if needed");
              return;
            }

            const newStatus = (resp.status || "pending").toLowerCase();
            if (newStatus === "approved") showToast("Approved");
            if (newStatus === "declined") showToast("Declined");
          })();
        });

        appListEl.appendChild(item);
      });

      if (!apps.length) {
        renderEmptyApps();
      }
    }

    if (detailClose) {
      detailClose.addEventListener("click", () => {
        hideDetails();
      });
    }

    if (detailCopy) {
      detailCopy.addEventListener("click", async () => {
        const text = detailAddress ? (detailAddress.textContent || "").trim() : "";
        if (!text || text === "No address") return;

        const ok = await tryCopy(text);
        if (!ok) {
          window.prompt("Copy address (Cmd+C):", text);
        }
      });
    }

    async function runBookingDecision(action) {
      if (!activeBookingId) {
        showToast("No booking selected");
        return;
      }

      if (detailConfirm) detailConfirm.disabled = true;
      if (detailDecline) detailDecline.disabled = true;

      const resp = await postBookingAction(activeBookingId, action);
      if (!resp || !resp.ok) {
        showToast("Could not update booking");
        if (detailConfirm) detailConfirm.disabled = false;
        if (detailDecline) detailDecline.disabled = false;
        return;
      }

      const newStatus = String(resp.status || "").toLowerCase();
      if (newStatus === "confirmed") {
        showToast("Confirmed");
      } else if (newStatus === "declined") {
        showToast("Declined");
      } else {
        showToast("Updated");
      }

      window.setTimeout(() => {
        window.location.reload();
      }, 400);
    }

    if (detailConfirm) {
      detailConfirm.addEventListener("click", () => {
        runBookingDecision("confirm");
      });
    }

    if (detailDecline) {
      detailDecline.addEventListener("click", () => {
        runBookingDecision("decline");
      });
    }

    if (detailCancel) {
      detailCancel.addEventListener("click", async () => {
        if (!activeBookingId) {
          showToast("No booking selected");
          return;
        }

        if (!confirm("Cancel this appointment?")) return;

        detailCancel.disabled = true;

        const resp = await postBookingCancel(activeBookingId);
        if (!resp || !resp.ok) {
          showToast("Could not cancel booking");
          detailCancel.disabled = false;
          return;
        }

        showToast("Cancelled");
        window.setTimeout(() => {
          window.location.reload();
        }, 400);
      });
    }


    if (detailEditTime) {
      detailEditTime.addEventListener("click", () => {
        if (!activeBookingId) {
          showToast("No booking selected");
          return;
        }

        isEditingTime = true;
        if (detailEditRow) detailEditRow.classList.remove("d-none");
        if (detailSaveTime) detailSaveTime.classList.remove("d-none");
        if (detailCancelEdit) detailCancelEdit.classList.remove("d-none");
      });
    }

    if (detailCancelEdit) {
      detailCancelEdit.addEventListener("click", () => {
        isEditingTime = false;
        if (detailEditRow) detailEditRow.classList.add("d-none");
        if (detailSaveTime) detailSaveTime.classList.add("d-none");
        if (detailCancelEdit) detailCancelEdit.classList.add("d-none");
      });
    }

    if (detailSaveTime) {
      detailSaveTime.addEventListener("click", async () => {
        if (!isEditingTime) {
          return;
        }
        if (!activeBookingId) {
          showToast("No booking selected");
          return;
        }

        const startVal = detailStart ? (detailStart.value || "").trim() : "";
        const endVal = detailEnd ? (detailEnd.value || "").trim() : "";

        if (!startVal || !endVal) {
          showToast("Start and end are required");
          return;
        }

        if (endVal <= startVal) {
          showToast("End must be after start");
          return;
        }

        detailSaveTime.disabled = true;

        const resp = await postBookingReschedule(activeBookingId, startVal, endVal);
        if (!resp || !resp.ok) {
          showToast(resp && resp.error ? resp.error : "Could not save time");
          detailSaveTime.disabled = false;
          return;
        }

        showToast("Saved");
        window.setTimeout(() => {
          window.location.reload();
        }, 400);
      });
    }

    document.addEventListener("keydown", (ev) => {
      if (ev.key === "b" || ev.key === "B") {
        if (createBtn) {
          createBtn.click();
        }
      }

      if (ev.key === "Escape") {
        hideDetails();
      }
    });


    const toggleApps = document.getElementById("toggleApps");
    const appSection = document.getElementById("appSection");
    if (toggleApps && appSection) {
      toggleApps.addEventListener("click", () => {
        const expanded = toggleApps.getAttribute("aria-expanded") === "true";
        setExpanded(toggleApps, appSection, !expanded);
      });
    }
  });
</script>
{% endblock %}