{% extends "booking_app/base.html" %}
{% block title %}Calendar{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-lg-10">
    <div class="card-soft p-3 p-md-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <h1 class="h3 mb-1">Nazar’s Calendar</h1>
          <span class="time-badge">Chicago time</span>
        </div>
      </div>

      <div id="calendar"></div>

      <div class="stats-row" aria-label="Dashboard counts">
        <div class="stats-pill">
          <span class="stats-label">Today</span>
          <span class="stats-value" id="todayBookingCount">0</span>
          <span class="stats-suffix">bookings</span>
        </div>
        <div class="stats-pill">
          <span class="stats-label">Pending</span>
          <span class="stats-value" id="pendingAppCount">0</span>
          <span class="stats-suffix">applications</span>
        </div>
      </div>

      <div id="detailCard" class="detail-card d-none" aria-live="polite">
        <div class="detail-header">
          <div>
            <div class="detail-title" id="detailTitle">Booking</div>
            <div class="detail-sub" id="detailWhen"></div>
          </div>
          <button
            type="button"
            class="btn btn-sm btn-outline-secondary"
            id="detailClose"
            aria-label="Close details"
          >
            Close
          </button>
        </div>

        <div class="detail-body">
          <div class="detail-line">
            <span class="detail-label">Address</span>
            <span class="detail-value" id="detailAddress"></span>
          </div>
        </div>

        <div class="detail-actions">
          <button
            type="button"
            class="btn btn-outline-secondary"
            id="detailCopy"
          >
            Copy address
          </button>
          <a class="btn btn-accent" href="/bookings/" id="detailOpenBookings">
            Open bookings
          </a>
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2 justify-content-end mt-3 mb-3">
        <a class="btn btn-accent" id="createBookingBtn" href="/book/?admin=1">
          Create booking
        </a>
        <a class="btn btn-outline-secondary" href="/bookings/">
          View booking list
        </a>
        <a
          class="btn btn-outline-secondary"
          href="/django-admin/booking_app/newclientapplication/"
          target="_blank"
          rel="noopener"
        >
          View applications
        </a>
      </div>


      <div class="mt-4 section-card">
        <button
          type="button"
          class="section-toggle"
          id="toggleApps"
          aria-expanded="true"
        >
          <span class="section-title">New client applications</span>
          <span class="small text-muted" id="appCount"></span>
          <span class="section-caret" aria-hidden="true">▾</span>
        </button>

        <div id="appSection">
          <div class="list-group" id="appList"></div>
          <div class="small text-muted mt-2">
            Pending only. Approve or decline here. Admin is optional.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>

  .time-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 999px;
    background: rgba(246, 196, 83, 0.22);
    border: 1px solid rgba(246, 196, 83, 0.45);
    font-size: 12px;
    font-weight: 600;
    color: rgba(17, 24, 39, 0.85);
  }

  /* Collapsible section header tile */
  .section-card {
    background: rgba(255, 255, 255, 0.55);
    border: 1px solid rgba(17, 24, 39, 0.06);
    border-radius: 18px;
    padding: 12px;
    box-shadow: 0 10px 26px rgba(16, 24, 40, 0.10);
    transition:
      transform 140ms ease,
      box-shadow 140ms ease,
      background 140ms ease;
  }

  .section-card:hover {
    background: rgba(255, 255, 255, 0.62);
    box-shadow: 0 12px 30px rgba(16, 24, 40, 0.12);
  }

  .section-toggle {
    width: 100%;
    border: 0;
    background: rgba(255, 255, 255, 0.72);
    border-radius: 16px;
    padding: 14px 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    text-align: left;
    box-shadow: 0 2px 12px rgba(16, 24, 40, 0.07);
  }

  .section-toggle:hover {
    background: rgba(255, 255, 255, 0.78);
  }

  .section-toggle:focus {
    outline: none;
    box-shadow:
      0 0 0 3px rgba(246, 196, 83, 0.35),
      0 2px 10px rgba(16, 24, 40, 0.06);
  }

  .section-title {
    font-weight: 600;
    flex: 1;
  }

  .section-caret {
    font-size: 18px;
    line-height: 1;
    transition: transform 160ms ease;
  }

  .section-toggle.is-collapsed .section-caret {
    transform: rotate(-90deg);
  }

  #appSection {
    margin-top: 12px;
    padding: 2px;
  }

  .section-card .list-group-item {
    border-radius: 12px;
    margin-bottom: 8px;
  }

  .section-card .list-group-item:last-child {
    margin-bottom: 0;
  }

  .app-row {
    display: flex;
    align-items: start;
    justify-content: space-between;
    gap: 12px;
  }

  .app-meta {
    margin-top: 2px;
  }

  .app-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: stretch;
    min-width: 120px;
  }

  .app-actions .btn {
    width: 100%;
    white-space: nowrap;
  }

  .app-actions .btn-approve {
    background: rgba(34, 197, 94, 0.12);
    border-color: rgba(34, 197, 94, 0.35);
    color: rgba(17, 24, 39, 0.95);
  }

  .app-actions .btn-approve:hover {
    background: rgba(34, 197, 94, 0.18);
    border-color: rgba(34, 197, 94, 0.45);
  }

  .app-actions .btn-decline {
    background: rgba(239, 68, 68, 0.10);
    border-color: rgba(239, 68, 68, 0.30);
    color: rgba(17, 24, 39, 0.95);
  }

  .app-actions .btn-decline:hover {
    background: rgba(239, 68, 68, 0.16);
    border-color: rgba(239, 68, 68, 0.40);
  }

  .app-admin-link {
    font-size: 12px;
    color: rgba(17, 24, 39, 0.60);
    text-decoration: none;
  }

  .app-admin-link:hover {
    text-decoration: underline;
  }

  /* FullCalendar: make today more obvious in month view */
  .fc .fc-daygrid-day.fc-day-today {
    background: rgba(246, 196, 83, 0.18);
  }

  .fc .fc-daygrid-day.fc-day-today {
    outline: 2px solid rgba(246, 196, 83, 0.55);
    outline-offset: -2px;
    border-radius: 10px;
  }

  .fc .fc-daygrid-day.fc-day-today .fc-daygrid-day-number {
    background: rgba(246, 196, 83, 0.90);
    color: rgba(17, 24, 39, 0.95);
    border-radius: 999px;
    padding: 2px 8px;
    font-weight: 700;
  }

  .fc .fc-toolbar-title {
    letter-spacing: -0.01em;
  }

  .detail-card {
    margin-top: 14px;
    background: rgba(255, 255, 255, 0.75);
    border: 1px solid rgba(17, 24, 39, 0.08);
    border-radius: 18px;
    padding: 14px;
    box-shadow: 0 10px 26px rgba(16, 24, 40, 0.10);
  }

  .detail-header {
    display: flex;
    align-items: start;
    justify-content: space-between;
    gap: 12px;
  }

  .detail-title {
    font-weight: 700;
    letter-spacing: -0.01em;
  }

  .detail-sub {
    margin-top: 2px;
    font-size: 13px;
    color: rgba(17, 24, 39, 0.65);
  }

  .detail-body {
    margin-top: 10px;
  }

  .detail-line {
    display: flex;
    gap: 10px;
    align-items: baseline;
    flex-wrap: wrap;
  }

  .detail-label {
    font-size: 12px;
    font-weight: 700;
    color: rgba(17, 24, 39, 0.70);
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .detail-value {
    font-size: 14px;
    color: rgba(17, 24, 39, 0.90);
    word-break: break-word;
  }

  .detail-actions {
    margin-top: 12px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .stats-row {
    margin-top: 12px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .stats-pill {
    display: inline-flex;
    align-items: baseline;
    gap: 8px;
    padding: 10px 12px;
    border-radius: 16px;
    background: rgba(255, 255, 255, 0.70);
    border: 1px solid rgba(17, 24, 39, 0.08);
    box-shadow: 0 6px 18px rgba(16, 24, 40, 0.08);
  }

  .stats-label {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: rgba(17, 24, 39, 0.60);
  }

  .stats-value {
    font-size: 18px;
    font-weight: 800;
    color: rgba(17, 24, 39, 0.92);
  }

  .stats-suffix {
    font-size: 13px;
    color: rgba(17, 24, 39, 0.65);
  }
  .toast-wrap {
    position: fixed;
    right: 18px;
    bottom: 18px;
    z-index: 9999;
    display: grid;
    gap: 10px;
    max-width: 320px;
  }

  .toast {
    background: rgba(255, 255, 255, 0.92);
    border: 1px solid rgba(17, 24, 39, 0.10);
    border-radius: 14px;
    padding: 10px 12px;
    box-shadow: 0 10px 30px rgba(16, 24, 40, 0.12);
    font-size: 13px;
    font-weight: 700;
    color: rgba(17, 24, 39, 0.95);
  }
</style>

<link
  href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css"
  rel="stylesheet"
/>
<script
  src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js">
</script>

<script>
  document.addEventListener("DOMContentLoaded", async function () {
    const el = document.getElementById("calendar");
    const appListEl = document.getElementById("appList");
    const appCountEl = document.getElementById("appCount");
    const todayCountEl = document.getElementById("todayBookingCount");
    const pendingCountEl = document.getElementById("pendingAppCount");

    const createBtn = document.getElementById("createBookingBtn");

    const detailCard = document.getElementById("detailCard");
    const detailTitle = document.getElementById("detailTitle");
    const detailWhen = document.getElementById("detailWhen");
    const detailAddress = document.getElementById("detailAddress");
    const detailCopy = document.getElementById("detailCopy");
    const detailClose = document.getElementById("detailClose");

    function showToast(message) {
      let wrap = document.getElementById("toastWrap");
      if (!wrap) {
        wrap = document.createElement("div");
        wrap.id = "toastWrap";
        wrap.className = "toast-wrap";
        document.body.appendChild(wrap);
      }

      const t = document.createElement("div");
      t.className = "toast";
      t.textContent = message;
      wrap.appendChild(t);

      window.setTimeout(() => {
        t.remove();
      }, 2200);
    }

    let selectedStart = null;
    let selectedEnd = null;

    function fmtChicago(iso) {
      try {
        const d = new Date(iso);
        const fmt = new Intl.DateTimeFormat("en-US", {
          timeZone: "America/Chicago",
          weekday: "short",
          month: "short",
          day: "numeric",
          hour: "numeric",
          minute: "2-digit",
        });
        return fmt.format(d);
      } catch (e) {
        return "";
      }
    }

    function timeOnly(iso) {
      try {
        const d = new Date(iso);
        const fmt = new Intl.DateTimeFormat("en-US", {
          timeZone: "America/Chicago",
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        });
        return fmt.format(d);
      } catch (e) {
        return "";
      }
    }

    function chicagoDayKey(isoOrDate) {
      const d = typeof isoOrDate === "string"
        ? new Date(isoOrDate)
        : isoOrDate;

      const parts = new Intl.DateTimeFormat("en-US", {
        timeZone: "America/Chicago",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
      }).formatToParts(d);

      const y = parts.find((p) => p.type === "year")?.value || "";
      const m = parts.find((p) => p.type === "month")?.value || "";
      const da = parts.find((p) => p.type === "day")?.value || "";

      return `${y}-${m}-${da}`;
    }

    function jumpTo(calendar, iso) {
      if (!iso) return;

      calendar.changeView("timeGridDay");
      calendar.gotoDate(iso);

      const t = timeOnly(iso);
      if (t && typeof calendar.scrollToTime === "function") {
        const hhmm = new Date(iso).toISOString().slice(11, 16);
        calendar.scrollToTime(hhmm);
      }
    }

    function setExpanded(btn, section, expanded) {
      if (!btn || !section) return;

      btn.setAttribute("aria-expanded", expanded ? "true" : "false");
      btn.classList.toggle("is-collapsed", !expanded);

      if (expanded) {
        section.classList.remove("d-none");
      } else {
        section.classList.add("d-none");
      }
    }

    async function tryCopy(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch (e) {
          return fallbackCopy(text);
        }
      }
      return fallbackCopy(text);
    }

    function fallbackCopy(text) {
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.setAttribute("readonly", "");
      ta.style.position = "fixed";
      ta.style.top = "0";
      ta.style.left = "0";
      ta.style.width = "1px";
      ta.style.height = "1px";
      ta.style.opacity = "0";
      ta.style.pointerEvents = "none";

      document.body.appendChild(ta);

      ta.focus({ preventScroll: true });
      ta.select();
      ta.setSelectionRange(0, ta.value.length);

      let ok = false;
      try {
        ok = document.execCommand("copy");
      } catch (e) {
        ok = false;
      }

      ta.remove();
      return ok;
    }

    function getCookie(name) {
      const v = document.cookie || "";
      const parts = v.split(";");
      for (let i = 0; i < parts.length; i++) {
        const p = parts[i].trim();
        if (p.startsWith(name + "=")) {
          return decodeURIComponent(p.substring(name.length + 1));
        }
      }
      return "";
    }

    async function postAppAction(appId, action) {
      const csrf = getCookie("csrftoken");
      const url = `/api/application/${appId}/action/`;

      const body = new URLSearchParams();
      body.set("action", action);

      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Accept": "application/json",
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          "X-CSRFToken": csrf,
        },
        body: body.toString(),
      });

      if (!res.ok) {
        return { ok: false };
      }

      try {
        return await res.json();
      } catch (e) {
        return { ok: false };
      }
    }

    function toIsoLocal(d) {
      try {
        return d.toISOString();
      } catch (e) {
        return "";
      }
    }

    function addHours(d, hours) {
      const x = new Date(d.getTime());
      x.setHours(x.getHours() + hours);
      return x;
    }

    function updateCreateLink() {
      if (!createBtn) return;

      if (!selectedStart) {
        createBtn.href = "/book/?admin=1";
        return;
      }

      const s = encodeURIComponent(toIsoLocal(selectedStart));
      const e = encodeURIComponent(toIsoLocal(selectedEnd));
      createBtn.href = `/book/?admin=1&slot_start=${s}&slot_end=${e}`;
    }

    function showDetails(title, startIso, endIso, address) {
      if (!detailCard) return;

      if (detailTitle) {
        detailTitle.textContent = title || "Booking";
      }

      if (detailWhen) {
        if (startIso) {
          const startTxt = fmtChicago(startIso);
          const endTxt = endIso ? timeOnly(endIso) : "";
          detailWhen.textContent = endTxt ? `${startTxt} – ${endTxt}` : startTxt;
        } else {
          detailWhen.textContent = "";
        }
      }

      if (detailAddress) {
        detailAddress.textContent = address || "No address";
      }

      detailCard.classList.remove("d-none");
      detailCard.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }

    function hideDetails() {
      if (!detailCard) return;
      detailCard.classList.add("d-none");
    }

    let data = [];
    try {
      const res = await fetch("/api/calendar-events/");
      if (res.ok) {
        data = await res.json();
      }
    } catch (e) {
      data = [];
    }

    data.sort((a, b) => {
      const as = a.start || "";
      const bs = b.start || "";
      return as.localeCompare(bs);
    });

    const calendar = new FullCalendar.Calendar(el, {
      timeZone: "America/Chicago",
      initialView: "dayGridMonth",
      height: "auto",
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay",
      },
      events: data,
      dateClick: function (info) {
        calendar.changeView("timeGridDay");
        calendar.gotoDate(info.dateStr);

        selectedStart = info.date;
        selectedEnd = addHours(info.date, 1);
        updateCreateLink();
      },
      eventClick: function (info) {
        info.jsEvent.preventDefault();

        const title = info.event.title || "Booking";
        const startIso = info.event.startStr || "";
        const endIso = info.event.endStr || "";
        const addr = (info.event.extendedProps
          && info.event.extendedProps.address)
          ? info.event.extendedProps.address
          : "";

        showDetails(title, startIso, endIso, addr);
      },
    });

    calendar.render();

    selectedStart = new Date();
    selectedEnd = addHours(selectedStart, 1);
    updateCreateLink();

    if (todayCountEl) {
      const todayKey = chicagoDayKey(new Date());
      const todayBookings = data.filter((e) => {
        if (!e.start) return false;
        return chicagoDayKey(e.start) === todayKey;
      }).length;
      todayCountEl.textContent = String(todayBookings);
    }

    let apps = [];
    try {
      const resApps = await fetch("/api/pending-applications/");
      if (resApps.ok) {
        apps = await resApps.json();
      }
    } catch (e) {
      apps = [];
    }

    if (appCountEl) {
      appCountEl.textContent = apps.length ? `${apps.length} pending` : "";
    }

    if (pendingCountEl) {
      pendingCountEl.textContent = String(apps.length);
    }

    if (appListEl) {
      appListEl.innerHTML = "";

      function updatePendingCounters(newCount) {
        if (appCountEl) {
          appCountEl.textContent = newCount ? `${newCount} pending` : "";
        }
        if (pendingCountEl) {
          pendingCountEl.textContent = String(newCount);
        }
      }

      function renderEmptyApps() {
        appListEl.innerHTML = "";
        const emptyA = document.createElement("div");
        emptyA.className = "text-muted small";
        emptyA.textContent = "No pending applications.";
        appListEl.appendChild(emptyA);
      }

      apps.slice(0, 30).forEach((a) => {
        const item = document.createElement("div");
        item.className = "list-group-item";
        item.dataset.appId = String(a.id || "");

        const name = a.name || "Application";
        const zip = a.zip_code ? `ZIP ${a.zip_code}` : "";
        const addr = a.address || "";
        const when = a.created ? fmtChicago(a.created) : "";
        const meta = [addr, zip, when].filter(Boolean).join(" · ");

        const adminUrl = a.admin_url || "";
        const adminHtml = adminUrl
          ? `<a class="app-admin-link" href="${adminUrl}" target="_blank" rel="noopener">Admin</a>`
          : "";

        item.innerHTML =
          `<div class="app-row">`
          +
          `<div>`
          +
          `<div class="fw-semibold">${name}</div>`
          +
          `<div class="small text-muted app-meta">${meta}</div>`
          +
          `${adminHtml ? `<div class="mt-1">${adminHtml}</div>` : ""}`
          +
          `</div>`
          +
          `<div class="app-actions">`
          +
          `<button type="button" class="btn btn-sm btn-outline-secondary btn-approve" data-action="approve">Approve</button>`
          +
          `<button type="button" class="btn btn-sm btn-outline-secondary btn-decline" data-action="decline">Decline</button>`
          +
          `</div>`
          +
          `</div>`;

        item.addEventListener("click", (ev) => {
          const btn = ev.target.closest("button[data-action]");
          if (!btn) return;
          ev.preventDefault();
          ev.stopPropagation();

          const appId = item.dataset.appId;
          const action = (btn.getAttribute("data-action") || "").trim();
          if (!appId || !action) return;

          const approveBtn = item.querySelector(
            'button[data-action="approve"]'
          );
          const declineBtn = item.querySelector(
            'button[data-action="decline"]'
          );

          if (approveBtn) approveBtn.disabled = true;
          if (declineBtn) declineBtn.disabled = true;

          (async () => {
            const resp = await postAppAction(appId, action);
            if (!resp || !resp.ok) {
              if (approveBtn) approveBtn.disabled = false;
              if (declineBtn) declineBtn.disabled = false;
              showToast("Could not update. Try again.");
              return;
            }

            const newStatus = (resp.status || "pending").toLowerCase();
            if (newStatus === "approved") {
              showToast("Approved");
            } else if (newStatus === "declined") {
              showToast("Declined");
            }

            // Remove from local list + UI
            apps = apps.filter((x) => String(x.id) !== String(appId));
            item.remove();

            updatePendingCounters(apps.length);

            if (!apps.length) {
              renderEmptyApps();
            }
          })();
        });

        appListEl.appendChild(item);
      });

      if (!apps.length) {
        renderEmptyApps();
      }
    }

    if (detailClose) {
      detailClose.addEventListener("click", () => {
        hideDetails();
      });
    }

    if (detailCopy) {
      detailCopy.addEventListener("click", async () => {
        const text = detailAddress ? (detailAddress.textContent || "").trim() : "";
        if (!text || text === "No address") return;

        const ok = await tryCopy(text);
        if (!ok) {
          window.prompt("Copy address (Cmd+C):", text);
        }
      });
    }

    document.addEventListener("keydown", (ev) => {
      if (ev.key === "b" || ev.key === "B") {
        if (createBtn) {
          createBtn.click();
        }
      }

      if (ev.key === "Escape") {
        hideDetails();
      }
    });


    const toggleApps = document.getElementById("toggleApps");
    const appSection = document.getElementById("appSection");
    if (toggleApps && appSection) {
      toggleApps.addEventListener("click", () => {
        const expanded = toggleApps.getAttribute("aria-expanded") === "true";
        setExpanded(toggleApps, appSection, !expanded);
      });
    }
  });
</script>
{% endblock %}